---
import ContactModal from "./ContactModal.astro";

const currentPath = Astro.url.pathname;
const isProyectosPage = currentPath === "/proyectos";
const isProjectDetailPage = currentPath.startsWith("/proyectos/");
---

<nav
  class={`navbar ${isProyectosPage || isProjectDetailPage ? "navbar--solid" : ""}`}
  id="navbar"
  data-is-subpage={isProyectosPage || isProjectDetailPage ? "true" : "false"}
>
  <div class="navbar__container">
    <!-- Logo -->
    <a href="/" class="navbar__logo-link" id="logo-link">
      <img
        src="/logo-simple.webp"
        alt="STREET Inmobiliaria Comercial"
        class="navbar__logo"
        width="45"
        height="45"
      />
    </a>

    <!-- Desktop Menu -->
    <div class="navbar__menu desktop-menu">
      {
        isProjectDetailPage ? (
          <a href="/proyectos" class="navbar__link navbar__link--back">
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            <span>Regresar a proyectos</span>
          </a>
        ) : isProyectosPage ? (
          <a
            href="/"
            class="navbar__link navbar__link--back"
            data-navigate-home="proyectos"
          >
            <svg
              width="16"
              height="16"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            <span>Regresar al inicio</span>
          </a>
        ) : (
          <>
            <a href="#proyectos" class="navbar__link" data-section="proyectos">
              Proyectos
            </a>
            <a href="#nosotros" class="navbar__link" data-section="nosotros">
              Nosotros
            </a>
            <button
              class="navbar__link navbar__link--button"
              id="contact-trigger"
            >
              Contacto
            </button>
          </>
        )
      }
    </div>

    <!-- Mobile Menu Button -->
    <button
      class="navbar__mobile-toggle"
      id="mobile-toggle"
      aria-label="Abrir menú"
      aria-expanded="false"
    >
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
      <span class="hamburger-line"></span>
    </button>
  </div>

  <!-- Mobile Menu Overlay -->
  <div class="navbar__mobile-overlay" id="mobile-overlay">
    <!-- Mobile Menu Close Button -->
    <button
      class="mobile-menu__close"
      id="mobile-menu-close"
      aria-label="Cerrar menú"
    >
      <span></span>
      <span></span>
    </button>

    <!-- Mobile Menu Logo -->
    <div class="mobile-menu__logo">
      <img src="/logo-simple.webp" alt="STREET" width="80" height="80" />
    </div>

    <div class="mobile-menu">
      {
        isProjectDetailPage ? (
          <a
            href="/proyectos"
            class="mobile-menu__link mobile-menu__link--back"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            <span>Regresar a proyectos</span>
          </a>
        ) : isProyectosPage ? (
          <a
            href="/"
            class="mobile-menu__link mobile-menu__link--back"
            data-navigate-home="proyectos"
          >
            <svg
              width="20"
              height="20"
              viewBox="0 0 24 24"
              fill="none"
              stroke="currentColor"
              stroke-width="2"
              stroke-linecap="round"
              stroke-linejoin="round"
            >
              <path d="M19 12H5M12 19l-7-7 7-7" />
            </svg>
            <span>Regresar al inicio</span>
          </a>
        ) : (
          <>
            <a
              href="#proyectos"
              class="mobile-menu__link"
              data-section="proyectos"
            >
              <span class="mobile-menu__number">01</span>
              <span class="mobile-menu__text">Proyectos</span>
            </a>
            <a
              href="#nosotros"
              class="mobile-menu__link"
              data-section="nosotros"
            >
              <span class="mobile-menu__number">02</span>
              <span class="mobile-menu__text">Nosotros</span>
            </a>
            <button
              class="mobile-menu__link mobile-menu__link--button"
              id="mobile-contact-trigger"
            >
              <span class="mobile-menu__number">03</span>
              <span class="mobile-menu__text">Contacto</span>
            </button>
          </>
        )
      }
    </div>

    <!-- Mobile Menu Footer -->
    <div class="mobile-menu__footer">
      <p class="mobile-menu__tagline">Inteligencia Comercial</p>
      <div class="mobile-menu__social">
        <a
          href="https://www.instagram.com/streetinteligenciacomercial/"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Visitar Instagram"
          class="social-link"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M12 2.163c3.204 0 3.584.012 4.85.07 3.252.148 4.771 1.691 4.919 4.919.058 1.265.069 1.645.069 4.849 0 3.205-.012 3.584-.069 4.849-.149 3.225-1.664 4.771-4.919 4.919-1.266.058-1.644.07-4.85.07-3.204 0-3.584-.012-4.849-.07-3.26-.149-4.771-1.699-4.919-4.92-.058-1.265-.07-1.644-.07-4.849 0-3.204.013-3.583.07-4.849.149-3.227 1.664-4.771 4.919-4.919 1.266-.057 1.645-.069 4.849-.069zm0-2.163c-3.259 0-3.667.014-4.947.072-4.358.2-6.78 2.618-6.98 6.98-.059 1.281-.073 1.689-.073 4.948 0 3.259.014 3.668.072 4.948.2 4.358 2.618 6.78 6.98 6.98 1.281.058 1.689.072 4.948.072 3.259 0 3.668-.014 4.948-.072 4.354-.2 6.782-2.618 6.979-6.98.059-1.28.073-1.689.073-4.948 0-3.259-.014-3.667-.072-4.947-.196-4.354-2.617-6.78-6.979-6.98-1.281-.059-1.69-.073-4.949-.073zm0 5.838c-3.403 0-6.162 2.759-6.162 6.162s2.759 6.163 6.162 6.163 6.162-2.759 6.162-6.163-2.759-6.162-6.162-6.162zm0 10.162c-2.209 0-4-1.79-4-4 0-2.209 1.791-4 4-4s4 1.791 4 4c0 2.21-1.791 4-4 4zm6.406-11.845c-.796 0-1.441.645-1.441 1.44s.645 1.44 1.441 1.44c.795 0 1.439-.645 1.439-1.44s-.644-1.44-1.439-1.44z"
            ></path>
          </svg>
        </a>
        <a
          href="https://www.facebook.com/streetinteligenciacomercial"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Visitar Facebook"
          class="social-link"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M9 8h-3v4h3v12h5v-12h3.642l.358-4h-4v-2.21c0-.837.191-1.177.883-1.177h3.117v-4.613l-4.497-.001c-4.988 0-5.503 3.483-5.503 5.483v2.518z"
            ></path>
          </svg>
        </a>
        <a
          href="https://wa.me/523325813250"
          target="_blank"
          rel="noopener noreferrer"
          aria-label="Contactar por WhatsApp"
          class="social-link"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M12.04 2c-5.46 0-9.91 4.45-9.91 9.91 0 1.75.46 3.45 1.32 4.95L2.05 22l5.25-1.38c1.45.79 3.08 1.21 4.74 1.21 5.46 0 9.91-4.45 9.91-9.91 0-2.65-1.03-5.14-2.9-7.01A9.816 9.816 0 0012.04 2zm5.66 14.36c-.24.66-1.37 1.26-1.91 1.34-.51.08-1.01.1-1.49-.09-.34-.14-1.05-.39-2.25-1.24-1.59-1.11-2.64-2.99-2.72-3.12-.08-.13-.65-1.36-.65-2.59 0-1.23.62-1.84.87-2.09.24-.25.53-.31.71-.31.17 0 .35 0 .5.01.16 0 .38-.06.59.45.21.51.72 1.78.79 1.9.07.13.12.27.02.44-.1.17-.15.27-.3.42-.15.15-.31.31-.44.42-.14.13-.29.27-.13.56.16.29.74 1.22 1.59 1.97 1.09.97 2.01 1.27 2.29 1.41.29.14.46.12.63-.07.17-.19.72-.84.91-1.13.19-.29.38-.24.63-.14.26.1 1.65.78 1.93.92.29.14.48.21.55.33.07.12.07.69-.17 1.35z"
            ></path>
          </svg>
        </a>
        <a
          href="mailto:hola@streetmx.com"
          aria-label="Enviar correo electrónico"
          class="social-link"
        >
          <svg
            xmlns="http://www.w3.org/2000/svg"
            width="22"
            height="22"
            viewBox="0 0 24 24"
            fill="currentColor"
          >
            <path
              d="M0 3v18h24v-18h-24zm21.518 2l-9.518 7.713-9.518-7.713h19.036zm-19.518 14v-11.817l10 8.104 10-8.104v11.817h-20z"
            ></path>
          </svg>
        </a>
      </div>
    </div>
  </div>
</nav>

<ContactModal />

<style>
  /* CSS Variables */
  :root {
    --navbar-height: 90px;
    --navbar-height-mobile: 70px;
    --color-dark: #15152a;
    --color-cream: #f7efe6;
    --color-yellow: #fcc419;
    --transition-smooth: cubic-bezier(0.4, 0, 0.2, 1);
    --transition-expo: cubic-bezier(0.19, 1, 0.22, 1);
  }

  /* Main Navbar */
  .navbar {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: var(--navbar-height);
    z-index: 1000;
    transition:
      background-color 0.4s var(--transition-smooth),
      backdrop-filter 0.4s var(--transition-smooth),
      box-shadow 0.4s var(--transition-smooth);
    opacity: 0;
    visibility: hidden;
  }

  .navbar--solid {
    background-color: var(--color-cream);
    box-shadow: 0 2px 20px rgba(21, 21, 42, 0.08);
  }

  .navbar.scrolled {
    background-color: rgba(247, 239, 230, 0.95);
    backdrop-filter: blur(20px);
    box-shadow: 0 2px 30px rgba(21, 21, 42, 0.1);
  }

  .navbar.dark-section {
    --nav-text-color: var(--color-cream);
  }

  .navbar {
    --nav-text-color: var(--color-dark);
    --nav-logo-filter: none;
  }

  .navbar__container {
    max-width: 1600px;
    margin: 0 auto;
    padding: 0 5vw;
    height: 100%;
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  /* Logo */
  .navbar__logo-link {
    display: flex;
    align-items: center;
    text-decoration: none;
    transition: transform 0.3s var(--transition-smooth);
  }

  .navbar__logo-link:hover {
    transform: scale(1.02);
  }

  .navbar__logo {
    height: 45px;
    width: auto;
    object-fit: contain;
    filter: var(--nav-logo-filter);
    transition: filter 0.4s var(--transition-smooth);
  }

  /* Desktop Menu */
  .desktop-menu {
    display: flex;
    align-items: center;
    gap: 3rem;
  }

  .navbar__link {
    font-family: "Neue Montreal", Helvetica, sans-serif;
    font-size: 14px;
    font-weight: 500;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: var(--nav-text-color);
    text-decoration: none;
    position: relative;
    padding: 0.5rem 0;
    background: none;
    border: none;
    cursor: pointer;
    transition: color 0.3s var(--transition-smooth);
  }

  .navbar__link::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 0;
    height: 1px;
    background-color: currentColor;
    transition: width 0.3s var(--transition-expo);
  }

  .navbar__link:hover::after {
    width: 100%;
  }

  .navbar__link--back {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.75rem 1.5rem;
    border: 1px solid currentColor;
    border-radius: 100px;
    transition:
      background-color 0.3s var(--transition-smooth),
      color 0.3s var(--transition-smooth);
  }

  .navbar__link--back::after {
    display: none;
  }

  .navbar__link--back:hover {
    background-color: var(--color-dark);
    color: var(--color-cream);
  }

  .navbar__link--button {
    display: flex;
    align-items: center;
    gap: 0.5rem;
  }

  /* Mobile Toggle Button */
  .navbar__mobile-toggle {
    display: none;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    width: 44px;
    height: 44px;
    background: transparent;
    border: none;
    cursor: pointer;
    padding: 0;
    gap: 6px;
    z-index: 1002;
  }

  .hamburger-line {
    display: block;
    width: 24px;
    height: 2px;
    background-color: var(--nav-text-color);
    transition:
      transform 0.3s var(--transition-expo),
      opacity 0.3s var(--transition-expo),
      background-color 0.3s var(--transition-smooth);
  }

  .navbar__mobile-toggle.active .hamburger-line:nth-child(1) {
    transform: translateY(8px) rotate(45deg);
  }

  .navbar__mobile-toggle.active .hamburger-line:nth-child(2) {
    opacity: 0;
  }

  .navbar__mobile-toggle.active .hamburger-line:nth-child(3) {
    transform: translateY(-8px) rotate(-45deg);
  }

  /* Mobile Menu Overlay */
  .navbar__mobile-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100vh;
    background-color: var(--color-dark);
    z-index: 10001;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    opacity: 0;
    visibility: hidden;
    transition:
      opacity 0.5s var(--transition-expo),
      visibility 0.5s var(--transition-expo);
  }

  .navbar__mobile-overlay.active {
    opacity: 1;
    visibility: visible;
  }

  .mobile-menu {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 2rem;
  }

  .mobile-menu__link {
    display: flex;
    align-items: center;
    gap: 1rem;
    font-family: "Monument Extended", sans-serif;
    font-size: clamp(2rem, 8vw, 4rem);
    color: var(--color-cream);
    text-decoration: none;
    text-transform: uppercase;
    letter-spacing: -0.02em;
    background: none;
    border: none;
    cursor: pointer;
    opacity: 0;
    transform: translateY(30px);
    transition:
      opacity 0.4s var(--transition-expo),
      transform 0.4s var(--transition-expo),
      color 0.3s var(--transition-smooth);
  }

  .navbar__mobile-overlay.active .mobile-menu__link {
    opacity: 1;
    transform: translateY(0);
  }

  .navbar__mobile-overlay.active .mobile-menu__link:nth-child(1) {
    transition-delay: 0.1s;
  }
  .navbar__mobile-overlay.active .mobile-menu__link:nth-child(2) {
    transition-delay: 0.2s;
  }
  .navbar__mobile-overlay.active .mobile-menu__link:nth-child(3) {
    transition-delay: 0.3s;
  }

  .mobile-menu__link:hover {
    color: var(--color-yellow);
  }

  .mobile-menu__number {
    font-family: "Neue Montreal", sans-serif;
    font-size: 0.875rem;
    color: var(--color-yellow);
    opacity: 0.6;
  }

  .mobile-menu__link--back {
    font-size: clamp(1.5rem, 6vw, 3rem);
    border: 2px solid var(--color-cream);
    padding: 1rem 2rem;
    border-radius: 100px;
    opacity: 1;
    transform: none;
  }

  .mobile-menu__link--back:hover {
    background-color: var(--color-cream);
    color: var(--color-dark);
  }

  /* Mobile Menu Logo */
  .mobile-menu__logo {
    margin-bottom: 2rem;
    opacity: 0;
    transform: translateY(-20px);
    transition:
      opacity 0.4s var(--transition-expo) 0.1s,
      transform 0.4s var(--transition-expo) 0.1s;
  }

  .navbar__mobile-overlay.active .mobile-menu__logo {
    opacity: 1;
    transform: translateY(0);
  }

  .mobile-menu__logo img {
    width: 80px;
    height: 80px;
    object-fit: contain;
  }

  /* Mobile Menu Close Button */
  .mobile-menu__close {
    position: absolute;
    top: 1.25rem;
    right: 1.25rem;
    width: 48px;
    height: 48px;
    background-color: var(--color-cream);
    border: none;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10002;
    opacity: 0;
    transform: scale(0.8);
    transition:
      opacity 0.3s var(--transition-expo) 0.2s,
      transform 0.3s var(--transition-expo) 0.2s,
      background-color 0.3s var(--transition-smooth);
  }

  .navbar__mobile-overlay.active .mobile-menu__close {
    opacity: 1;
    transform: scale(1);
  }

  .mobile-menu__close:hover {
    background-color: var(--color-yellow);
  }

  .mobile-menu__close span {
    position: absolute;
    width: 20px;
    height: 2px;
    background-color: var(--color-dark);
    transition: background-color 0.3s var(--transition-smooth);
  }

  .mobile-menu__close span:first-child {
    transform: rotate(45deg);
  }

  .mobile-menu__close span:last-child {
    transform: rotate(-45deg);
  }

  /* Mobile Menu Footer */
  .mobile-menu__footer {
    position: absolute;
    bottom: 3rem;
    left: 0;
    right: 0;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 1.5rem;
    opacity: 0;
    transform: translateY(20px);
    transition:
      opacity 0.4s var(--transition-expo) 0.4s,
      transform 0.4s var(--transition-expo) 0.4s;
  }

  .navbar__mobile-overlay.active .mobile-menu__footer {
    opacity: 1;
    transform: translateY(0);
  }

  .mobile-menu__tagline {
    font-family: "Neue Montreal", sans-serif;
    font-size: 0.75rem;
    text-transform: uppercase;
    letter-spacing: 0.2em;
    color: var(--color-cream);
    opacity: 0.5;
  }

  .mobile-menu__social {
    display: flex;
    gap: 1.5rem;
  }

  .social-link {
    color: var(--color-cream);
    opacity: 0.6;
    transition:
      opacity 0.3s var(--transition-smooth),
      transform 0.3s var(--transition-smooth);
  }

  .social-link:hover {
    opacity: 1;
    transform: translateY(-3px);
  }

  /* Responsive */
  @media (max-width: 1024px) {
    .navbar__logo {
      height: 40px;
    }

    .navbar__link {
      font-size: 13px;
    }

    .desktop-menu {
      gap: 2rem;
    }
  }

  @media (max-width: 768px) {
    .navbar {
      height: var(--navbar-height-mobile);
    }

    .navbar__logo {
      height: 36px;
    }

    .desktop-menu {
      display: none;
    }

    .navbar__mobile-toggle {
      display: flex;
    }

    .navbar__container {
      padding: 0 1.5rem;
    }
  }

  /* Prevent body scroll when mobile menu or modal is open */
  :global(body.menu-open) {
    overflow: hidden;
  }

  /* Hide preloader when mobile menu is open */
  :global(body.menu-open) .container,
  :global(body.menu-open) .hero-img {
    opacity: 0 !important;
    visibility: hidden !important;
    transition:
      opacity 0.3s ease,
      visibility 0.3s ease;
  }
</style>

<script>
  import { gsap } from "gsap";

  // DOM Elements
  const navbar = document.getElementById("navbar");
  const mobileToggle = document.getElementById("mobile-toggle");
  const mobileOverlay = document.getElementById("mobile-overlay");
  const logoLink = document.getElementById("logo-link");
  const contactTrigger = document.getElementById("contact-trigger");
  const mobileContactTrigger = document.getElementById(
    "mobile-contact-trigger",
  );

  const isSubpage =
    navbar?.dataset.isSubpage === "true" ||
    window.location.pathname.startsWith("/proyectos/");
  const mobileMenuClose = document.getElementById("mobile-menu-close");

  // Initialize Navbar Animation
  function initNavbarAnimation() {
    // Check if we're returning from a subpage (skip preloader scenario)
    const skipPreloader = sessionStorage.getItem("skipPreloader") === "true";

    if (skipPreloader) {
      // Show navbar immediately without animation
      gsap.set(navbar, { y: 0, opacity: 1, visibility: "visible" });
      sessionStorage.removeItem("skipPreloader");
    } else if (isSubpage) {
      // On subpages, show immediately
      gsap.set(navbar, { y: 0, opacity: 1, visibility: "visible" });
    } else {
      // On home page, wait for preloaderComplete event
      window.addEventListener("preloaderComplete", () => {
        gsap.fromTo(
          navbar,
          {
            y: -100,
            opacity: 0,
            visibility: "hidden",
          },
          {
            duration: 1.2,
            y: 0,
            opacity: 1,
            visibility: "visible",
            ease: "expo.out",
          },
        );
      });
    }
  }

  // Mobile Menu Toggle
  function toggleMobileMenu() {
    const isActive = mobileToggle?.classList.contains("active");

    if (isActive) {
      closeMobileMenu();
    } else {
      openMobileMenu();
    }
  }

  function openMobileMenu() {
    mobileToggle?.classList.add("active");
    mobileToggle?.setAttribute("aria-expanded", "true");
    mobileOverlay?.classList.add("active");
    document.body.classList.add("menu-open");
  }

  function closeMobileMenu() {
    mobileToggle?.classList.remove("active");
    mobileToggle?.setAttribute("aria-expanded", "false");
    mobileOverlay?.classList.remove("active");
    document.body.classList.remove("menu-open");
  }

  // Contact Modal
  function openContactModal() {
    document.dispatchEvent(new CustomEvent("open-contact-modal"));
    // Close mobile menu if open
    closeMobileMenu();
  }

  // Smooth Scroll to Section
  function scrollToSection(sectionId: string) {
    const section = document.getElementById(sectionId);
    if (section) {
      const navbarHeight = navbar?.offsetHeight || 90;
      const sectionTop =
        section.getBoundingClientRect().top + window.pageYOffset - navbarHeight;

      window.scrollTo({
        top: sectionTop,
        behavior: "smooth",
      });
    }
  }

  // Handle navigation from subpages
  function handleSubpageNavigation(targetSection: string) {
    // Store flag to skip preloader
    sessionStorage.setItem("skipPreloader", "true");
    sessionStorage.setItem("scrollToSection", targetSection);
  }

  // Scroll Detection for Navbar Background
  function handleScroll() {
    const scrollY = window.scrollY;

    if (scrollY > 100) {
      navbar?.classList.add("scrolled");
    } else {
      navbar?.classList.remove("scrolled");
    }
  }

  // Intersection Observer for Section Contrast
  function initContrastObserver() {
    // Sections that have light/cream backgrounds where dark navbar text works
    const lightSections = document.querySelectorAll("#proyectos, #nosotros");

    const observerOptions = {
      root: null,
      rootMargin: `-90px 0px 0px 0px`, // Account for navbar height
      threshold: 0.1,
    };

    const observer = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        if (entry.isIntersecting) {
          // When entering light sections, ensure dark text
          navbar?.classList.remove("dark-section");
        }
      });
    }, observerOptions);

    lightSections.forEach((section) => observer.observe(section));

    // Check for Hero section which has dark backgrounds occasionally
    const heroSection = document.querySelector(".hero");
    if (heroSection) {
      const heroObserver = new IntersectionObserver(
        (entries) => {
          entries.forEach((entry) => {
            if (entry.isIntersecting) {
              // In hero section, check if background image is active
              const heroBg = document.querySelector(".hero-bg");
              if (heroBg?.classList.contains("active")) {
                navbar?.classList.add("dark-section");
              } else {
                navbar?.classList.remove("dark-section");
              }
            }
          });
        },
        { ...observerOptions, threshold: 0.5 },
      );

      heroObserver.observe(heroSection);
    }
  }

  // Event Listeners
  document.addEventListener("DOMContentLoaded", () => {
    initNavbarAnimation();
    initContrastObserver();

    // Mobile toggle
    mobileToggle?.addEventListener("click", toggleMobileMenu);
    mobileMenuClose?.addEventListener("click", closeMobileMenu);

    // Contact triggers
    contactTrigger?.addEventListener("click", openContactModal);
    mobileContactTrigger?.addEventListener("click", openContactModal);

    // Close modal on escape key
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        closeMobileMenu();
      }
    });

    // Scroll event with throttling
    let ticking = false;
    window.addEventListener("scroll", () => {
      if (!ticking) {
        window.requestAnimationFrame(() => {
          handleScroll();
          ticking = false;
        });
        ticking = true;
      }
    });

    // Handle section links
    document.querySelectorAll("[data-section]").forEach((link) => {
      link.addEventListener("click", (e) => {
        e.preventDefault();
        const sectionId = link.getAttribute("data-section");
        if (sectionId) {
          scrollToSection(sectionId);
          closeMobileMenu();
        }
      });
    });

    // Handle navigation from subpages
    document.querySelectorAll("[data-navigate-home]").forEach((link) => {
      link.addEventListener("click", () => {
        const sectionId = link.getAttribute("data-navigate-home");
        if (sectionId) {
          handleSubpageNavigation(sectionId);
        }
      });
    });

    // Logo click - scroll to top on main page
    logoLink?.addEventListener("click", (e) => {
      if (!isSubpage) {
        e.preventDefault();
        window.scrollTo({ top: 0, behavior: "smooth" });
      }
    });

    // Check for scroll-to-section after navigation
    const scrollToSectionId = sessionStorage.getItem("scrollToSection");
    const urlParams = new URLSearchParams(window.location.search);
    const skipPreloaderParam = urlParams.get("skipPreloader") === "true";

    if (scrollToSectionId && !isSubpage && skipPreloaderParam) {
      sessionStorage.removeItem("scrollToSection");
      setTimeout(() => {
        scrollToSection(scrollToSectionId);
      }, 100);
    } else {
      // If no skipPreloader param, clear any stored scroll target to avoid accidental redirects
      sessionStorage.removeItem("scrollToSection");
    }

    // Watch for hero background changes
    const heroBg = document.querySelector(".hero-bg");
    if (heroBg) {
      const bgObserver = new MutationObserver((mutations) => {
        mutations.forEach((mutation) => {
          if (
            mutation.type === "attributes" &&
            mutation.attributeName === "class"
          ) {
            const isHeroBgActive = heroBg.classList.contains("active");
            const heroElement = document.querySelector(".hero");
            const isHeroVisible = heroElement
              ? heroElement.getBoundingClientRect().top < 100
              : false;

            if (isHeroBgActive && isHeroVisible) {
              navbar?.classList.add("dark-section");
            } else {
              navbar?.classList.remove("dark-section");
            }
          }
        });
      });

      bgObserver.observe(heroBg, { attributes: true });
    }
  });
</script>
